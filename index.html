<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mapa obiektów noclegowych w Polsce</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="docs/images/favicon.ico"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      .leaflet-container {
        height: 400px;
        width: 600px;
        max-width: 100%;
        max-height: 100%;
      }
    </style>
  </head>
  <body>
    <div>
      <a
        class="btn btn-primary"
        data-bs-toggle="offcanvas"
        href="#offcanvasExample"
        role="button"
        aria-controls="offcanvasExample"
      >
        Filtry
      </a>
      <div id="warn"></div>
    </div>

    <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasExample"
      aria-labelledby="offcanvasExampleLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Filtry</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <form>
        <div id="form">
          <div class="offcanvas-body">
            <a
              class="btn btn-primary"
              data-bs-toggle="collapse"
              href="#udogodnienia"
              role="button"
              aria-expanded="true"
              aria-controls="udogodnienia"
            >
              Udogodnienia
            </a>
          </div>
          <div class="collapse.toggle">
            <div class="card card-body" id="udogodnienia">

            </div>
          </div>
          <div>
            <button type="button" class="btn btn-primary" onclick="getPoints()">
              Wyślij
            </button>
          </div>
        </div>
      </form>
    </div>


    <div id="map" style="width: 100%; height: 94.5%"></div>

    <div
      class="modal fade"
      id="alertModal"
      tabindex="-1"
      aria-labelledby="alertModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertModalLabel">Uwaga</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Osiągnięto limit obiektów: 2000.<br />Zawęź filtry aby zobaczyć
            wszystkie pasujące obiekty
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Zamknij
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const map = L.map("map").setView([54.4506593, 18.5607375125286], 7);
      function createMap() {
        const tiles = L.tileLayer(
          "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          }
        ).addTo(map);

        //   const marker = L.marker([51.5, -0.09])
        //     .addTo(map)
        //     .bindPopup("<b>Hello world!</b><br />I am a popup.")
        //     .openPopup();

        //   const circle = L.circle([51.508, -0.11], {
        //     color: "red",
        //     fillColor: "#f03",
        //     fillOpacity: 0.5,
        //     radius: 500,
        //   })
        //     .addTo(map)
        //     .bindPopup("I am a circle.");
        //   L.circle([51.508, -0.11], {
        //     color: "red",
        //     fillColor: "#f03",
        //     fillOpacity: 0.5,
        //     radius: 500,
        //   })
        //     .addTo(map)
        //     .bindPopup("I am a circle.");

        //   const polygon = L.polygon([
        //     [51.509, -0.08],
        //     [51.503, -0.06],
        //     [51.51, -0.047],
        //   ])
        //     .addTo(map)
        //     .bindPopup("I am a polygon.");
      }

      //   map.on("click", onMapClick);
      document.onload(
        createMap(),
        createCheckboxesFromJSON(
          "https://api.turystyka.gov.pl/registers/open/cwoh/filters/questionnaires"
        )
      );

      function getData(url) {
        // const url1 = 'https://api.turystyka.gov.pl/registers/open/cwoh/filters/questionnaires';
        fetch(url)
          .then((res) => res.json())
          .then((out) => (data1 = out))
          .catch((err) => console.log(err));
      }

      function createCheckboxesFromJSON(url) {
        // Załaduj plik JSON z podanego URL
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            // Znajdź element z id "form"
            const formContainer = document.getElementById("udogodnienia");

            // Utwórz nową tablicę z unikatowymi wartościami
            const uniqueContent = Array.from(
              new Map(data.content.map((item) => [item.key, item])).values()
            );

            // Utwórz kontener dla wszystkich checkboxów
            const checkboxesContainer = document.createElement("div");
            // checkboxesContainer.style.display = "flex";
            // checkboxesContainer.style.flexWrap = "wrap";
            checkboxesContainer.class = "form-check-input";
            // Iteruj po tablicy z unikatowymi wartościami
            uniqueContent.forEach((item) => {
              // Utwórz checkbox
              console.log(item);
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = item.key;
              checkbox.key = item.key;
              // Utwórz label dla checkboxa
              const label = document.createElement("label");
              label.textContent = item.name;

              // Utwórz kontener dla checkbox i label
              const checkboxContainer = document.createElement("div");
              checkboxContainer.style.marginRight = "10px"; // Dodaj margines między checkboxami
              checkboxContainer.appendChild(checkbox);
              checkboxContainer.appendChild(label);

              // Dodaj kontener do kontenera dla wszystkich checkboxów
              checkboxesContainer.appendChild(checkboxContainer);
            });

            // Dodaj kontener z checkboxami do elementu z id "form"
            formContainer.appendChild(checkboxesContainer);
          })
          .catch((error) =>
            console.error("Błąd podczas ładowania pliku JSON:", error)
          );
      }

      async function sendCheckedValues(e) {
        // Pobierz wszystkie zaznaczone checkboxy
        const checkedCheckboxes = document
          .getElementById("form")
          .querySelectorAll('#form input[type="checkbox"]:checked');

        // Pobierz wartości key z zaznaczonych checkboxów
        const checkedKeys = [];
        for (let index = 0; index < checkedCheckboxes.length; index++) {
          checkedKeys.push(checkedCheckboxes[index].value);
        }

        // Utwórz adres URL z pobranymi kluczami
        const apiUrl = `https://api.turystyka.gov.pl/registers/open/cwoh?questionnaires=${checkedKeys.join(
          ","
        )}&size=99999`;
        console.log(apiUrl);

        try {
          // Pobierz dane z API asynchronicznie
          const response = await fetch(apiUrl);
          const data = await response.json();

          // Tutaj możesz przetwarzać dane pobrane z API
          console.log(data);
          return data; // Zwróć dane
        } catch (error) {
          console.error("Błąd podczas pobierania danych:", error);
          return null; // Możesz zwrócić null lub inny wskaźnik błędu
        }
      }

      // Użycie funkcji
      sendCheckedValues(event).then((data) => {
        if (data) {
          // Tutaj masz dostęp do danych
          console.log("Dane:", data);
          // Możesz dalej pracować na danych
        }
      });

      function setPoint(point, nazwa, city, uid) {
        L.marker(point, {
          color: "red",
          fillColor: "#f03",
          fillOpacity: 0.5,
          radius: 500,
        })
          .addTo(map)
          .bindPopup(
            "<b>" +
              nazwa +
              "</b><br>" +
              city +
              "</b>" +
              "<br><a href=https://api.turystyka.gov.pl/registers/open/cwoh/" +
              uid +
              ">Szczegóły</a>"
          );
      }

      function getPoints(e) {
        document
          .querySelectorAll(".leaflet-interactive")
          .forEach((el) => el.remove());

        var points = sendCheckedValues();

        points.then((data) => {
          // Tutaj możesz pracować na danych
          dane = data;
          // warn = document.getElementById("warn")
          // warn.outerHTML = "";

          if (dane["content"].length > 1999) {
            var modal = new bootstrap.Modal(
              document.getElementById("alertModal")
            );
            modal.show();
          }

          for (let index = 0; index < dane["content"].length; index++) {
            point = dane["content"][index].spatialLocation.coordinates;
            name = dane["content"][index].name;
            city = dane["content"][index].city;
            uid = dane["content"][index].uid;
            setPoint(point, name, city, uid);
          }
        });
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
